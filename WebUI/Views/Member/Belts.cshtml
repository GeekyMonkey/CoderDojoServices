@model List<CoderDojo.Belt>
@{
    Member member = ViewBag.CurrentMember;
    List<CoderDojo.Belt> belts = Model;
    ViewBag.Title = "Belts";
    ViewBag.MenuActive = "Belts";
    List<MemberBelt> MemberBelts = member.MemberBelts.Where(mb => mb.Awarded != null).OrderBy(mb => mb.Belt.SortOrder).ToList();
    List<MemberBelt> MemberBeltsPending = member.MemberBelts.Where(mb => mb.Awarded == null && mb.RejectedDate == null).OrderBy(mb => mb.Belt.SortOrder).ToList();
    List<Guid> BeltsEarnedIds = MemberBelts.Select(mb => mb.BeltId).ToList();
    List<Guid> BeltsPendingIds = MemberBeltsPending.Select(mb => mb.BeltId).ToList();
    List<Belt> BeltsNotEarned = belts.Where(b => BeltsEarnedIds.Contains(b.Id) == false).ToList();
}

@section HeaderLeft
{
}

@section HeaderRight
{
}

@section Footer
{
}

@section Panels
{
    @Html.Partial("_MemberMenu")
}

<div data-role="collapsible-set" data-corners="true" data-inset="true">
    <h3>Belts Earned</h3>
    @if (MemberBelts.Count() == 0)
    {
        <p>You have not yet earned any belts.</p>
    }
    @foreach (var memberBelt in MemberBelts)
    {
        <div data-role="collapsible" data-content-theme="a" class="BeltHeader" data-color="@memberBelt.Belt.HexCode">
            <h3>@memberBelt.Belt.Color</h3>
            <div data-role="fieldcontain">
                <p>@memberBelt.Belt.Description</p>
                <blockquote>@memberBelt.ApplicationNotes</blockquote>
                <p>Awarded on @memberBelt.Awarded.Value.ToString("yyyy MMM dd")</p>
                <blockquote>@memberBelt.AwardedNotes - @memberBelt.Adult.FullName</blockquote>
            </div>
        </div>
    }
</div>


@if (BeltsNotEarned.Count() > 0) {
    bool first = true;
    <div data-role="collapsible-set" data-corners="true" data-inset="true">
        <h3>Belts Not Earned</h3>
        @foreach (var belt in BeltsNotEarned)
        {
            <div data-role="collapsible" data-content-theme="a" class="BeltHeader" data-color="@belt.HexCode">
                <h3>@belt.Color</h3>
                <div data-role="fieldcontain">
                    <p>@belt.Description</p>
                    @if (first) {
                        first = false;
                        if (BeltsPendingIds.Contains(belt.Id))
                        {
                            <p>Application for the <span class="BeltColorText">@(belt.Color.ToLower()) belt</span> was submitted on @(MemberBeltsPending.FirstOrDefault(mb => mb.BeltId == belt.Id).ApplicationDate.Value.ToString("yyyy MMM dd")). Talk to a mentor to find out what's up.</p>
                        } else {
                            <a href="/Member/BeltApplication/@belt.Id.ToString("N")" data-role="button" data-inline="true" data-icon="star">Apply</a>
                        }
                    }
                </div>
            </div>
        }
    </div>
}

<script type="text/javascript">
    $(function () {
        setTimeout(function () {
            $(".BeltHeader").each(function (i, e) {
                $(this).find(".ui-btn-inner").css("transition", "background-color 2s");
                $(this).find(".ui-btn-inner").css("background-color", $(this).data("color"));
                $(this).find(".BeltColorText").css("color", $(this).data("color"));
            });
        }, 1000);
    });
</script>

@model List<CoderDojo.AttendanceModel>
@{
    DateTime attendanceDate = ViewBag.AttendanceDate;
    string attendanceDateFormatted = attendanceDate.ToString("yyyy-MM-dd");
    ViewBag.Title = "Attendance " + attendanceDateFormatted;
    ViewBag.MenuActive = "Attendance";
    List<CoderDojo.AttendanceModel> attendance = Model;
}

@section HeaderLeft {
}

@section HeaderTitle {
    <div data-role="controlgroup" data-type="horizontal" data-mini="true">
        <label style="float:left;padding-top: 7px;">Attendance&nbsp;</label>
        <select data-inline="true" id="AttendanceDateSelect">
            @foreach(DateTime dt in ViewBag.SessionDates) {
                string dateFormatted = dt.ToString("yyyy-MM-dd");
                <option @if (dateFormatted == attendanceDateFormatted) { <text>selected='selected'</text>}>@dateFormatted</option>
            }
        </select>
    </div>
}

@section HeaderRight {
    <a href="MemberSignup?Mode=Attendance" data-role="button" data-icon="plus">Signup</a>
}

@section Footer
{
}

@section Panels
{
    @Html.Partial("_MentorMenu")
}

@using (Html.BeginForm("Attendance", "Member")) {
		<ul data-role="listview" data-autodividers="true" id="myFilter" data-filter="true" data-filter-placeholder="Search members..." data-filter-theme="a">
        @foreach (CoderDojo.AttendanceModel a in attendance)
        {
            string memId = a.MemberId.ToString("N");
            <li class="ui-corner-none">
                <input type="checkbox" id="P@(memId)" class="custom ui-corner-none"
                @if (a.Present) { <text>checked="checked"</text> } />
                <label for="P@(memId)">@a.MemberName</label>
            </li>
        }
        </ul>
}

<script type="text/javascript">
    (function ($) {
        $(":checkbox").die().live("change", function () {
            var checkbox = $(this);
            var checked = checkbox.is(':checked');

            // Prevent multiple calls of the same value
            var checkedString = '*' + checked;
            if ($(this).data("sentcheck", checked) != checkedString) {
                $(this).data("sentcheck", checked, checkedString);
                $.ajax("AttendanceChange", {
                    type: "POST",
                    data: {
                        memberId: checkbox.attr("id").substr(1),
                        present: checked,
                        attendanceDate: '@(attendanceDateFormatted)'
                    }
                });
            }
        });

        $("#AttendanceDateSelect").on("change", function (e) {
            var dateSelected = $("#AttendanceDateSelect").val();
            window.location = "/Mentor/Attendance?attendanceDate=" + dateSelected;
        });
    })(jQuery);
</script>
